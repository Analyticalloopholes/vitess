<!DOCTYPE html>
<html lang="en" itemscope itemtype="https://schema.org/WebPage">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Vitess / Horizontal Sharding</title>

        <!-- Webfont -->
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
    
    <!--<link rel="shortcut icon" type="image/png" href="/favicon.png">-->

    <!-- Bootstrap -->
    <link href="/libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Styles -->
    <link rel="stylesheet" type="text/css" href="/css/site.css" />
    <!-- Font Awesome icons -->
    <link href="/libs/font-awesome-4.4.0/css/font-awesome.min.css"
          rel="stylesheet"
          type="text/css">
    
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/libs/bootstrap/js/bootstrap.min.js"></script>


    <!-- metadata -->
    <meta name="og:title" content="Vitess / Horizontal Sharding"/>
    <meta name="og:image" content="/images/120x120.gif"/>
    <meta name="og:description" content="Servers and tools that scale MySQL databases for the web in cloud architectures or on dedicated hardware."/>

    <!-- GA -->
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-60219601-1', 'auto');
  ga('send', 'pageview');
</script>

  </head>
  <body class="docs" id="top_of_page">

    <span id="toc-depth" data-toc-depth="h2,h3"></span>


  	<nav id="common-nav" class="navbar navbar-fixed-top inverse">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">
        <img class="logo" src="/images/vitess-logo-large-cropped-2.png" alt="Vitess">
      </a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right" id="standard-menu-links">
        <li><a href="/overview/">Guides</a></li>
        <li><a href="/reference/vitess-api.html">Reference</a></li>
        <li><a href="http://blog.vitess.io/">Blog</a></li>
        <li><a href="https://github.com/youtube/vitess"><i class="fa fa-github"></i> GitHub</a></li>
        <!-- Hide link to blog unless we have actual posts -->
        <!-- <li><a href="/blog/" title="">Blog</a></li> -->
      </ul>
      <ul class="nav nav-stacked mobile-left-nav-menu" id="collapsed-left-menu">
                <li class="submenu">
          <h4 class="arrow-r no-top-margin">Overview</h4>
          <ul style="display: none">
            <li><a href="/overview/">What is Vitess</a></li>
            <li><a href="/overview/concepts.html">Key Concepts</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Getting Started</h4>
          <ul style="display: none">
            <li><a href="/getting-started/">Run Vitess on Kubernetes</a></li>
            <li><a href="/getting-started/local-instance.html">Run Vitess Locally</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">User Guide</h4>
          <ul style="display: none">
            <li><a href="/user-guide/introduction.html">Introduction</a>
            <li><a href="/user-guide/client-libraries.html">Client Libraries</a>
            <li><a href="/user-guide/backup-and-restore.html">Backing Up Data</a>
            <li><a href="/user-guide/reparenting.html">Reparenting</a></li>
            <li><a href="/user-guide/schema-management.html">Schema Management</a></li>
            <li style="padding-bottom: 0"><a href="/user-guide/sharding.html">Sharding</a>
              <ul style="list-style-type: none">
                <li><a href="/user-guide/horizontal-sharding.html">Horizontal Sharding (Codelab)</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/sharding-kubernetes.html">Sharding in Kubernetes (Codelab)</a></li>
              </ul>
            </li>
            <li><a href="/user-guide/transport-security-model.html">Transport Security Model</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Reference Guides</h4>
          <ul style="display: none">
            <li><a href="/reference/vitess-api.html">Vitess API</a>
            <li><a href="/reference/vtctl.html">vtctl Commands</a>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Other Resources</h4>
          <ul style="display: none">
            <li><a href="/resources/presentations.html">Presentations</a>
            <li><a href="http://blog.vitess.io/">Blog</a>
          </ul>
        </li>

        <div>
          <form method="get" action="/search/">
            <input name="q" type="text" placeholder="Search">
          </form>
        </div>

        <li><a href="https://github.com/youtube/vitess" style="font-size: 18px; margin-left: 0.25em;"><i class="fa fa-github"></i> GitHub</a></li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>



<div id="masthead">
  <div class="container">
    <div class="row">
      <div class="col-md-9">
        <h1>Horizontal Sharding</h1>
      </div>
    </div>
  </div>
</div>


<div class="container">
    <div class="row scroll-margin" id="toc-content-row">
    <div class="col-md-3" id="leftCol">
      <ul class="nav nav-stacked mobile-left-nav-menu" id="sidebar">
                <li class="submenu">
          <h4 class="arrow-r no-top-margin">Overview</h4>
          <ul style="display: none">
            <li><a href="/overview/">What is Vitess</a></li>
            <li><a href="/overview/concepts.html">Key Concepts</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Getting Started</h4>
          <ul style="display: none">
            <li><a href="/getting-started/">Run Vitess on Kubernetes</a></li>
            <li><a href="/getting-started/local-instance.html">Run Vitess Locally</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">User Guide</h4>
          <ul style="display: none">
            <li><a href="/user-guide/introduction.html">Introduction</a>
            <li><a href="/user-guide/client-libraries.html">Client Libraries</a>
            <li><a href="/user-guide/backup-and-restore.html">Backing Up Data</a>
            <li><a href="/user-guide/reparenting.html">Reparenting</a></li>
            <li><a href="/user-guide/schema-management.html">Schema Management</a></li>
            <li style="padding-bottom: 0"><a href="/user-guide/sharding.html">Sharding</a>
              <ul style="list-style-type: none">
                <li><a href="/user-guide/horizontal-sharding.html">Horizontal Sharding (Codelab)</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/sharding-kubernetes.html">Sharding in Kubernetes (Codelab)</a></li>
              </ul>
            </li>
            <li><a href="/user-guide/transport-security-model.html">Transport Security Model</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Reference Guides</h4>
          <ul style="display: none">
            <li><a href="/reference/vitess-api.html">Vitess API</a>
            <li><a href="/reference/vtctl.html">vtctl Commands</a>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Other Resources</h4>
          <ul style="display: none">
            <li><a href="/resources/presentations.html">Presentations</a>
            <li><a href="http://blog.vitess.io/">Blog</a>
          </ul>
        </li>

        <div>
          <form method="get" action="/search/">
            <input name="q" type="text" placeholder="Search">
          </form>
        </div>

      </ul>
    </div>
    <div class="col-md-2" id="rightCol">
      <div class="nav nav-stacked" id="tocSidebar">
        <div id="toc"></div>
      </div>
    </div>
    <div class="col-md-7" id="centerCol">
      <div id="centerTextCol">
        <p>This step-by-step guide explains how to split an unsharded keyspace into two shards.
(An unsharded keyspace has exactly one shard.)
The examples assume that the keyspace is named <code class="prettyprint">user_keyspace</code> and the shard is <code class="prettyprint">0</code>.
The sharded keyspace will use the <code class="prettyprint">user_keyspace_id</code> column as the keyspace ID.</p>

<p>You can use the same general instructions to reshard a sharded keyspace.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>To complete these steps, you must have:</p>

<ol>
<li><p>A running <a href="http://vitess.io/overview/concepts.html#keyspace">keyspace</a>.
A keyspace is a logical database that maps to one or more MySQL databases.</p></li>
<li><p>Two or more <a href="http://vitess.io/overview/concepts.html#tablet">rdonly tablets</a>
running on the source shard. You set the desired tablet type when starting
<code class="prettyprint">vttablet</code> with the <code class="prettyprint">-target_tablet_type</code> flag. See the
<a href="https://github.com/youtube/vitess/blob/master/examples/local/vttablet-up.sh">vttablet-up.sh</a>
script for example.</p>

<p>During resharding, one of these tablets will pause its replication to ensure
a consistent snapshot of the data. For this reason, you can&#39;t do resharding
if there are only <code class="prettyprint">master</code> and <code class="prettyprint">replica</code> tablets, because those are reserved
for live traffic and Vitess will never take them out of service for batch
processes like resharding.</p>

<p>Having at least two <code class="prettyprint">rdonly</code> tablets ensures that data updates that occur on
the source shard during the resharding process propagate to the destination
shard. Steps 3 and 4 of the resharding process discuss this in more detail.</p></li>
</ol>

<p>We recommend that you also review the
<a href="http://vitess.io/user-guide/sharding.html#range-based-sharding">Range-Based Sharding</a>
section of the <em>Sharding</em> guide.</p>

<h2 id="step-1-define-your-keyspace-id-on-the-source-shard">Step 1: Define your Keyspace ID on the Source Shard</h2>

<p><strong>Note:</strong> Skip this step if your keyspace already has multiple shards.</p>

<p>In this step, you add a column, which will serve as the
<a href="http://vitess.io/overview/concepts.html#keyspace-id">keyspace ID</a>, to each
table in the soon-to-be-sharded keyspace.
After the keyspace has been sharded, Vitess will use the column&#39;s value to route
each query to the proper shard.</p>

<h3 id="step-1-1-add-keyspace-id-to-each-database-table">Step 1.1: Add keyspace ID to each database table</h3>

<p>For each table in the unsharded keyspace, run the following <code class="prettyprint">alter</code> statement:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctlclient -server &lt;vtctld host:port&gt; ApplySchema <span class="se">\</span>
    -sql <span class="s2">&quot;alter table &lt;table name&gt; add &lt;keyspace ID column&gt;&quot;</span> <span class="se">\</span>
    &lt;keyspace name&gt;
</code></pre></div>
<p>In this example, the command looks like this:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctlclient -server &lt;vtctld host:port&gt; ApplySchema <span class="se">\</span>
    -sql <span class="s2">&quot;alter table &lt;table name&gt; add user_keyspace_id&quot;</span> <span class="se">\</span>
    user_keyspace
</code></pre></div>
<p>In the above statement, replace <code class="prettyprint">user_keyspace_id</code> with the column name that you
want to use to store the keyspace ID value.
Also replace <code class="prettyprint">user_keyspace</code> with the name of your keyspace.</p>

<h3 id="step-1-2-update-tables-to-contain-keyspace-id-values">Step 1.2: Update tables to contain keyspace ID values</h3>

<p>Backfill each row in each table with the appropriate keyspace ID value.
In this example, each <code class="prettyprint">user_keyspace_id</code> column contains a 64-bit hash of the
user ID in that column&#39;s row. Using a hash ensures that user IDs are randomly
and evenly distributed across shards.</p>

<h3 id="step-1-3-set-keyspace-id-in-topology-server">Step 1.3: Set keyspace ID in topology server</h3>

<p>Tell Vitess which column value identifies the keyspace ID by running the
following command:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctlclient -server &lt;vtctld host:port&gt; <span class="se">\</span>
    SetKeyspaceShardingInfo &lt;keyspace name&gt; &lt;keyspace ID column&gt; &lt;keyspace <span class="nb">type</span>&gt;
</code></pre></div>
<p>In this example, the command looks like this:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctlclient -server &lt;vtctld host:port&gt; <span class="se">\</span>
    SetKeyspaceShardingInfo user_keyspace user_keyspace_id uint64
</code></pre></div>
<p>Note that each table in the keyspace must have a column to identify the keyspace ID.
In addition, all of those columns must have the same name.</p>

<h2 id="step-2-prepare-the-destination-shards">Step 2: Prepare the destination shards</h2>

<p>In this step, you create the destination shards and tablets.
At the end of this step, the destination shards will have been created,
but they will not contain any data and will not serve any traffic.</p>

<p>This example shows how to split an unsharded database into two destination shards.
As noted in the
<a href="http://vitess.io/user-guide/sharding.html#key-ranges-and-partitions">Key Ranges and Partitions</a>
section, the value [ 0x80 ] is the middle value for sharding keys.
So, when you split this database into two shards, the
<a href="http://vitess.io/user-guide/sharding.html#shard-names-in-range-based-keyspaces">range-based shard names</a>
for those shards will be:</p>

<ul>
<li>-80</li>
<li>80-</li>
</ul>

<h3 id="step-2-1-create-destination-shards">Step 2.1: Create destination shards</h3>

<p>To create the destination shards, call the <code class="prettyprint">CreateShard</code> command.
You would have used the same command to create the source shard. Repeat the
following command for each shard you need to create:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctlclient -server &lt;vtctld host:port&gt; CreateShard &lt;keyspace name&gt;/&lt;shard name&gt;
</code></pre></div>
<p>In this example, you would run the command twice:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctlclient -server &lt;vtctld host:port&gt; CreateShard user_keyspace/80-
vtctlclient -server &lt;vtctld host:port&gt; CreateShard user_keyspace/-80
</code></pre></div>
<h3 id="step-2-2-create-destination-tablets">Step 2.2: Create destination tablets</h3>

<p>Start up <code class="prettyprint">mysqld</code> and <code class="prettyprint">vttablet</code> for the destination shards just like you did
for the source shards, but with a different <code class="prettyprint">-init_shard</code> argument and a
different unique tablet ID (specified via <code class="prettyprint">-tablet-path</code>).</p>

<p>The example <a href="https://github.com/youtube/vitess/blob/master/examples/local/vttablet-up.sh">vttablet-up.sh</a>
script has parameters at the top named <code class="prettyprint">shard</code> and <code class="prettyprint">uid_base</code> that can be used
to make these modifications.</p>

<p>As with the source shard, you should have two <a href="http://vitess.io/overview/concepts.html#tablet">rdonly tablets</a>
on each of the destination shards. The <code class="prettyprint">tablet_type</code> parameter at the top of
<code class="prettyprint">vttablet-up.sh</code> can be used to set this.</p>

<h3 id="step-2-3-initialize-replication-on-destination-shards">Step 2.3: Initialize replication on destination shards</h3>

<p>Next call the <code class="prettyprint">InitShardMaster</code> command to initialize MySQL replication in each destination shard.
You would have used the same commands to elect the master tablet on the source shard.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctlclient -server &lt;vtctld host:port&gt; <span class="se">\</span>
    InitShardMaster -force &lt;keyspace name&gt;/&lt;shard name&gt; &lt;tablet <span class="nb">alias</span>&gt;
</code></pre></div>
<p>In this example, you would run these commands:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctlclient -server &lt;vtctld host:port&gt; <span class="se">\</span>
    InitShardMaster -force user_keyspace/-80 &lt;tablet <span class="nb">alias</span>&gt;
vtctlclient -server &lt;vtctld host:port&gt; <span class="se">\</span>
    InitShardMaster -force user_keyspace/80- &lt;tablet <span class="nb">alias</span>&gt;
</code></pre></div>
<h2 id="step-3-clone-data-to-the-destination-shards">Step 3: Clone data to the destination shards</h2>

<p>In this step, you copy the database schema to each destination shard.
Then you copy the data to the destination shards. At the end of this
step, the destination tablets will be populated with data but will not
yet be serving traffic.</p>

<h3 id="step-3-1-copy-schema-to-destination-shards">Step 3.1: Copy schema to destination shards</h3>

<p>Call the <code class="prettyprint">CopySchemaShard</code> command to copy the database schema
from a rdonly tablet on the source shard to the destination shards:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctlclient -server &lt;vtctld host:port&gt; CopySchemaShard <span class="se">\</span>
    &lt;keyspace&gt;/&lt;<span class="nb">source </span>shard&gt; <span class="se">\</span>
    &lt;keyspace&gt;/&lt;destination shard&gt;
</code></pre></div>
<p>In this example, you would run these two commands:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctlclient -server &lt;vtctld host:port&gt; <span class="se">\</span>
    CopySchemaShard user_keyspace/0 user_keyspace/-80
vtctlclient -server &lt;vtctld host:port&gt; <span class="se">\</span>
    CopySchemaShard user_keyspace/0 user_keyspace/80-
</code></pre></div>
<h3 id="step-3-2-copy-data-from-source-shard-to-destination-shards">Step 3.2: Copy data from source shard to destination shards</h3>

<p>This step uses a <code class="prettyprint">vtworker</code> process to copy data from the source shard
to the destination shards. The <code class="prettyprint">vtworker</code> performs the following tasks:</p>

<ol>
<li><p>It finds a <code class="prettyprint">rdonly</code> tablet on the source shard and stops data
replication on the tablet. This prevents the data from changing
while it is being copied. During this time, the <code class="prettyprint">rdonly</code> tablet&#39;s
status is changed to <code class="prettyprint">worker</code>, and Vitess will stop routing app
traffic to it since it might not have up-to-date data.</p></li>
<li><p>It does a (concurrent) full scan of each table on the source shard.</p></li>
<li><p>It identifies the appropriate destination shard for each source row
based on the row&#39;s sharding key.</p></li>
<li><p>It streams the data to the master tablet on the correct destination shard.</p></li>
</ol>

<p>The following command starts the <code class="prettyprint">vtworker</code>:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">vtworker -min_healthy_rdonly_endpoints 1 -cell=&lt;cell name&gt; \
    SplitClone &lt;keyspace name&gt;/&lt;source shard name&gt;
</code></pre></div>
<p>For this example, run this command:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">vtworker -min_healthy_rdonly_endpoints 1 -cell=&lt;cell name&gt; \
    SplitClone user_keyspace/0
</code></pre></div>
<p>The amount of time that the worker takes to complete will depend
on the size of your dataset. When the process completes, the destination
shards contain the correct data but do not yet serve traffic.
The destination shards are also now running
<a href="http://vitess.io/user-guide/sharding.html#filtered-replication">filtered replication</a>.</p>

<h2 id="step-4-run-a-data-diff-to-verify-integrity">Step 4: Run a data diff to verify integrity</h2>

<p>Before the destination shard starts serving data, you want to ensure that
its data is up-to-date. Remember that the source tablet would not have
received updates to any of its records while the vtworker process was
copying data to the destination shards.</p>

<h3 id="step-4-1-use-filtered-replication-to-catch-up-to-source-data-changes">Step 4.1: Use filtered replication to catch up to source data changes</h3>

<p>Vitess uses <a href="http://vitess.io/user-guide/sharding.html#filtered-replication">filtered replication</a> to ensure that
data changes on the source shard during step 3 propagate successfully
to the destination shards. While this process happens automatically, the
time it takes to complete depends on how long step 3 took to complete and
the scope of the data changes on the source shard during that time.</p>

<p>You can see the filtered replication state for a destination shard by
viewing the status page of the shard&#39;s master tablet in your browser
(the vtctld web UI will link there from the tablet&#39;s <strong>STATUS</strong> button).
The Binlog Player table shows a <strong>SecondsBehindMaster</strong> column that
indicates how far the destination master is still behind the source shard.</p>

<h3 id="step-4-2-compare-data-on-source-and-destination-shards">Step 4.2: Compare data on source and destination shards</h3>

<p>In this step, you use another <code class="prettyprint">vtworker</code> process to ensure that the data
on the source and destination shards is identical. The vtworker can also
catch potential problems that might have occurred during the copying
process. For example, if the sharding key changed for a particular row
during step 3 or step 4.1, the data on the source and destination shards
might not be equal.</p>

<p>To start the <code class="prettyprint">vtworker</code>, run the following <code class="prettyprint">SplitDiff</code> command:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtworker -min_healthy_rdonly_endpoints<span class="o">=</span><span class="m">1</span> -cell<span class="o">=</span>&lt;cell name&gt; <span class="se">\</span>
    SplitDiff &lt;keyspace name&gt;/&lt;shard name&gt;
</code></pre></div>
<p>The commands for the two new destination shards in this example are shown
below. You need to complete this process for each destination shard.
However, you must remove one rdonly tablet from the source shard for each
diff process that is running. As such, it is recommended to run diffs
sequentially rather than in parallel.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtworker -min_healthy_rdonly_endpoints<span class="o">=</span><span class="m">1</span> -cell<span class="o">=</span>&lt;cell name&gt; <span class="se">\</span>
    SplitDiff user_keyspace/-80
vtworker -min_healthy_rdonly_endpoints<span class="o">=</span><span class="m">1</span> -cell<span class="o">=</span>&lt;cell name&gt; <span class="se">\</span>
    SplitDiff user_keyspace/80-
</code></pre></div>
<p>The vtworker performs the following tasks:</p>

<ol>
<li><p>It finds a health <code class="prettyprint">rdonly</code> tablet in the source shard and a healthy
<code class="prettyprint">rdonly</code> tablet in the destination shard.</p></li>
<li><p>It sets both tablets to stop serving app traffic, so data can be compared
reliably.</p></li>
<li><p>It pauses filtered replication on the destination master tablet.</p></li>
<li><p>It pauses replication on the source <code class="prettyprint">rdonly</code> tablet at a position higher
than the destination master&#39;s filtered replication position.</p></li>
<li><p>It resumes the destination master&#39;s filtered replication.</p></li>
<li><p>It allows the destination <code class="prettyprint">rdonly</code> tablet to catch up to the same position
as the source <code class="prettyprint">rdonly</code> tablet and then stops replication on the
destination <code class="prettyprint">rdonly</code> tablet.</p></li>
<li><p>It compares the schema on the source and destination <code class="prettyprint">rdonly</code> tablets.</p></li>
<li><p>It streams data from the source and destination tablets, using the
same sharding key constraints, and verifies that the data is equal.</p></li>
</ol>

<p>If the diff is successful on the first destination shard, repeat it
on the next destination shard.</p>

<h2 id="step-5-direct-traffic-to-destination-shards">Step 5: Direct traffic to destination shards</h2>

<p>After verifying that your destination shards contain the correct data,
you can start serving traffic from those shards.</p>

<h3 id="step-5-1-migrate-read-only-traffic">Step 5.1 Migrate read-only traffic</h3>

<p>The safest process is to migrate read-only traffic first. You will migrate
write operations in the following step, after the read-only traffic is
stable. The reason for splitting the migration into two steps is that
you can reverse the migration of read-only traffic without creating data
inconsistencies. However, you cannot reverse the migration of master
traffic without creating data inconsistencies.</p>

<p>Use the <code class="prettyprint">MigrateServedTypes</code> command to migrate <code class="prettyprint">rdonly</code> and <code class="prettyprint">replica</code> traffic.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">vtctlclient -server &lt;vtctld host:port&gt; \
    MigrateServedTypes &lt;keyspace name&gt;/&lt;source shard name&gt; rdonly
vtctlclient -server &lt;vtctld host:port&gt; \
    MigrateServedTypes &lt;keyspace name&gt;/&lt;source shard name&gt; replica
</code></pre></div>
<p>If something goes wrong during the migration of read-only traffic,
run the same commands with the <code class="prettyprint">-reverse</code> flag to return
read-only traffic to the source shard:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">vtctlclient -server &lt;vtctld host:port&gt; \
    MigrateServedTypes -reverse &lt;keyspace name&gt;/&lt;source shard name&gt; rdonly
vtctlclient -server &lt;vtctld host:port&gt; \
    MigrateServedTypes -reverse &lt;keyspace name&gt;/&lt;source shard name&gt; replica
</code></pre></div>
<h3 id="step-5-2-migrate-master-traffic">Step 5.2 Migrate master traffic</h3>

<p>Use the <code class="prettyprint">MigrateServedTypes</code> command again to migrate <code class="prettyprint">master</code>
traffic to the destination shard:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">vtctlclient -server &lt;vtctld host:port&gt; \
    MigrateServedTypes &lt;keyspace name&gt;/&lt;source shard name&gt; master
</code></pre></div>
<p>For this example, the command is:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">vtctlclient -server &lt;vtctld host:port&gt; MigrateServedTypes user_keyspace/0 master
</code></pre></div>
<h2 id="step-6-scrap-source-shard">Step 6: Scrap source shard</h2>

<p>If all of the other steps were successful, you can remove the source
shard, which should no longer be in use.</p>

<h3 id="step-6-1-remove-source-shard-tablets">Step 6.1: Remove source shard tablets</h3>

<p>Run the following command for each tablet in the source shard:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctlclient -server &lt;vtctld host:port&gt; DeleteTablet -allow_master &lt;<span class="nb">source </span>tablet <span class="nb">alias</span>&gt;
</code></pre></div>
<h3 id="step-6-2-delete-source-shard">Step 6.2: Delete source shard</h3>

<p>Run the following command:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctlclient -server &lt;vtctld host:port&gt; <span class="se">\</span>
    DeleteShard &lt;keyspace name&gt;/&lt;<span class="nb">source </span>shard name&gt;
</code></pre></div>
<p>For this example, the command is:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctlclient -server &lt;vtctld host:port&gt; DeleteShard user_keyspace/0
</code></pre></div>
      </div>
    </div>
  </div>

</div>


        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<!--    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>   -->
    <!-- Include all compiled plugins (below), or include individual files as needed -->
<!--
    <script src="/libs/bootstrap/js/bootstrap.min.js"></script>
-->
    <!-- Include the common site javascript -->
    <script src="/js/common.js" type="text/javascript" charset="utf-8"></script>


  </body>
</html>
